<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PRACTICE ENG - AI Learning</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&amp;family=Courier+Prime:wght@700&amp;display=swap" rel="stylesheet">
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; width: 100%; }
body {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  font-family: 'Fredoka', sans-serif;
  overflow: hidden;
  min-height: 100vh;
}

.app-wrapper { height: 100%; width: 100%; display: flex; flex-direction: column; }
.content { flex: 1; overflow-y: auto; width: 100%; }

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 5px; }

@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.card {
  background: white;
  border-radius: 4px;
  border: 3px solid #333;
  padding: 20px;
  box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
  transition: all 0.3s;
}

.btn {
  border: 3px solid #333;
  padding: 12px 24px;
  border-radius: 0px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 700;
  transition: all 0.1s;
  font-family: 'Fredoka', sans-serif;
}

.btn-primary { background: #667eea; color: white; box-shadow: 3px 3px 0px rgba(0,0,0,0.3); }
.btn-primary:hover { transform: translate(0px, -2px); box-shadow: 5px 5px 0px rgba(0,0,0,0.3); }
.btn-secondary { background: #764ba2; color: white; box-shadow: 3px 3px 0px rgba(0,0,0,0.3); }
.btn-danger { background: #ff6b6b; color: white; }
.btn-success { background: #51cf66; color: white; }

.input {
  width: 100%;
  padding: 12px;
  background: white;
  border: 3px solid #333;
  border-radius: 0px;
  font-size: 16px;
  outline: none;
  font-family: 'Fredoka', sans-serif;
}

.input:focus { box-shadow: 0 0 0 2px #667eea; }

.header {
  background: white;
  border-bottom: 4px solid #333;
  padding: 15px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 0px rgba(0,0,0,0.1);
  flex-wrap: wrap;
}

.nav-link {
  cursor: pointer;
  padding: 8px 16px;
  border-radius: 0px;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 700;
  font-size: 14px;
  color: #333;
  white-space: nowrap;
  border: 2px solid transparent;
}

.nav-link:hover { background: #f0f0f0; border: 2px solid #667eea; }
.nav-link.active { background: #667eea; color: white; border: 2px solid #333; }

.xp-badge {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 8px 16px;
  border-radius: 0px;
  font-weight: 700;
  font-size: 14px;
  border: 2px solid #333;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  align-items: center;
  justify-content: center;
}

.modal.show { display: flex; }

.modal-content {
  background: white;
  border: 4px solid #333;
  padding: 30px;
  border-radius: 4px;
  max-width: 600px;
  width: 90%;
  max-height: 80%;
  overflow-y: auto;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.grammar-feedback {
  padding: 16px;
  border-radius: 4px;
  margin-top: 12px;
  font-weight: 700;
}

.grammar-correct {
  background: #d4edda;
  color: #155724;
  border: 2px solid #28a745;
}

.grammar-wrong {
  background: #f8d7da;
  color: #721c24;
  border: 2px solid #f5c6cb;
}

.quiz-option {
  background: white;
  border: 2px solid #e0e0e0;
  border-radius: 4px;
  padding: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 600;
}

.quiz-option:hover { border-color: #667eea; background: #f8f9ff; }
.quiz-option.selected { border-color: #667eea; background: #667eea; color: white; }
.quiz-option.correct { border-color: #51cf66; background: #51cf66; color: white; }
.quiz-option.wrong { border-color: #ff6b6b; background: #ff6b6b; color: white; }

.profile-avatar {
  width: 120px;
  height: 120px;
  border: 3px solid #333;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  background: #667eea;
  color: white;
  overflow: hidden;
  margin: 0 auto 15px;
}

.profile-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.tournament-row {
  display: flex;
  justify-content: space-between;
  padding: 12px;
  background: white;
  border: 2px solid #e0e0e0;
  margin-bottom: 8px;
  align-items: center;
}

.progress-bar {
  width: 100%;
  height: 20px;
  background: white;
  border: 2px solid #333;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea, #764ba2);
  transition: width 0.3s ease;
}

.result-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

.result-table th {
  background: #667eea;
  color: white;
  padding: 12px;
  text-align: left;
  font-weight: 700;
  border: 2px solid #333;
}

.result-table td {
  padding: 12px;
  border: 2px solid #e0e0e0;
}

.result-table tr:hover {
  background: #f8f9ff;
}

.level-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 700;
  border: 2px solid #333;
}

.level-a1 { background: #e8f5e9; color: #2e7d32; border-color: #2e7d32; }
.level-a2 { background: #fff3e0; color: #e65100; border-color: #e65100; }
.level-b1 { background: #e3f2fd; color: #1565c0; border-color: #1565c0; }
.level-b2 { background: #f3e5f5; color: #6a1b9a; border-color: #6a1b9a; }
.level-c1 { background: #fce4ec; color: #c2185b; border-color: #c2185b; }
.level-c2 { background: #ffe0b2; color: #bf360c; border-color: #bf360c; }

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid #667eea;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 0.6s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.answer-card {
  background: white;
  border: 2px solid #e0e0e0;
  border-radius: 4px;
  padding: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.answer-card:hover { border-color: #667eea; }
.answer-card.selected { background: #667eea; color: white; border-color: #333; }
.answer-card.correct { background: #51cf66; color: white; border-color: #333; }
.answer-card.wrong { background: #ff6b6b; color: white; border-color: #333; }

.admin-panel {
  background: linear-gradient(135deg, #ff6b6b, #ff8787);
  color: white;
  padding: 20px;
  border-radius: 4px;
  margin-bottom: 20px;
  border: 3px solid #333;
}

.grammar-issue {
  background: #fff3cd;
  border-left: 4px solid #ffc107;
  padding: 12px;
  margin: 8px 0;
  border-radius: 4px;
}

.suggestion {
  background: #d1ecf1;
  border-left: 4px solid #17a2b8;
  padding: 12px;
  margin: 8px 0;
  border-radius: 4px;
}

.explanation-box {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 16px;
  border-radius: 4px;
  margin-top: 12px;
}

.project-credit {
  position: absolute;
  bottom: 10px;
  right: 15px;
  font-size: 11px;
  opacity: 0.5;
  color: rgba(255,255,255,0.7);
  text-align: right;
  line-height: 1.4;
}

.pixel-character {
  display: inline-block;
  width: 80px;
  height: 80px;
}
</style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body>
  <div class="app-wrapper" id="app"><!-- AUTH SCREEN -->
   <div id="auth-screen" style="display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative;">
    <div class="project-credit">
     ‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤<br>
     ‡∏ä‡∏±‡πâ‡∏ô‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4/1
    </div>
    <div class="card" style="max-width: 420px; width: 100%;">
     <div style="text-align: center; margin-bottom: 40px;">
      <svg class="pixel-character" viewbox="0 0 32 32"><!-- Hair --> <rect x="6" y="2" width="20" height="2" fill="#8b6f47" /> <rect x="5" y="4" width="2" height="2" fill="#8b6f47" /> <rect x="25" y="4" width="2" height="2" fill="#8b6f47" /> <!-- Head --> <rect x="8" y="4" width="16" height="8" fill="#fdbcb4" /> <!-- Eyes --> <rect x="10" y="6" width="2" height="2" fill="#000" /> <rect x="20" y="6" width="2" height="2" fill="#000" /> <!-- Eyebrows --> <rect x="10" y="5" width="2" height="1" fill="#8b6f47" /> <rect x="20" y="5" width="2" height="1" fill="#8b6f47" /> <!-- Nose --> <rect x="15" y="8" width="2" height="1" fill="#f0b8a0" /> <!-- Smile --> <rect x="12" y="10" width="8" height="1" fill="#000" /> <!-- Shirt (Blue) --> <rect x="6" y="12" width="20" height="8" fill="#667eea" /> <!-- Shirt details --> <rect x="14" y="12" width="4" height="1" fill="#764ba2" /> <!-- Arms --> <rect x="2" y="14" width="4" height="4" fill="#fdbcb4" /> <rect x="26" y="14" width="4" height="4" fill="#fdbcb4" /> <!-- Pants (Dark) --> <rect x="8" y="20" width="7" height="8" fill="#333" /> <rect x="17" y="20" width="7" height="8" fill="#333" /> <!-- Shoes --> <rect x="8" y="28" width="7" height="2" fill="#000" /> <rect x="17" y="28" width="7" height="2" fill="#000" />
      </svg>
      <h1 style="font-size: 32px; color: #667eea; margin-bottom: 8px; font-weight: 900;">PRACTICE ENG</h1>
      <p style="opacity: 0.6; font-size: 14px;">AI-Powered English Learning</p>
     </div>
     <div id="login-form">
      <h2 style="margin-bottom: 20px; font-size: 16px; font-weight: 700;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
      <div style="margin-bottom: 15px;"><input type="text" id="login-user" class="input" placeholder="Username">
      </div>
      <div style="margin-bottom: 20px;"><input type="password" id="login-pass" class="input" placeholder="Password">
      </div>
      <div id="login-error" style="color: #ff6b6b; font-size: 14px; margin-bottom: 15px; display: none; font-weight: 700;"></div><button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" id="login-btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‚ûú</button>
      <p style="text-align: center; opacity: 0.6; font-size: 13px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <span id="go-reg-link" style="color: #667eea; cursor: pointer; font-weight: 700;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏•‡∏¢</span></p>
     </div>
     <div id="register-form" style="display: none;">
      <h2 style="margin-bottom: 20px; font-size: 16px; font-weight: 700;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
      <div style="margin-bottom: 15px;"><input type="text" id="reg-name" class="input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">
      </div>
      <div style="margin-bottom: 15px;"><input type="text" id="reg-user" class="input" placeholder="Username">
      </div>
      <div style="margin-bottom: 20px;"><input type="password" id="reg-pass" class="input" placeholder="Password">
      </div>
      <div id="reg-error" style="color: #ff6b6b; font-size: 14px; margin-bottom: 15px; display: none; font-weight: 700;"></div><button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" id="reg-btn">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‚ûú</button>
      <p style="text-align: center; opacity: 0.6; font-size: 13px;">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? <span id="go-login-link" style="color: #667eea; cursor: pointer; font-weight: 700;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span></p>
     </div>
    </div>
   </div><!-- MAIN APP -->
   <div id="main-app" style="display: none; flex-direction: column; height: 100%;"><!-- Header -->
    <header class="header">
     <h1 style="font-size: 18px; color: #667eea; cursor: pointer; margin: 0; min-width: 160px; font-weight: 900; display: flex; align-items: center; gap: 8px;" onclick="navigateTo('home')">
      <svg width="24" height="24" viewbox="0 0 32 32"><rect x="6" y="2" width="20" height="2" fill="#667eea" /> <rect x="5" y="4" width="2" height="2" fill="#667eea" /> <rect x="25" y="4" width="2" height="2" fill="#667eea" /> <rect x="8" y="4" width="16" height="8" fill="#fdbcb4" /> <rect x="10" y="6" width="2" height="2" fill="#000" /> <rect x="20" y="6" width="2" height="2" fill="#000" /> <rect x="6" y="12" width="20" height="8" fill="#667eea" /> <rect x="2" y="14" width="4" height="4" fill="#fdbcb4" /> <rect x="26" y="14" width="4" height="4" fill="#fdbcb4" /> <rect x="8" y="20" width="7" height="8" fill="#333" /> <rect x="17" y="20" width="7" height="8" fill="#333" />
      </svg> ENG</h1>
     <nav style="display: flex; gap: 8px; flex: 1; overflow-x: auto; margin: 0 20px;">
      <div class="nav-link active" data-page="home" onclick="navigateTo('home')">
       üè† Home
      </div>
      <div class="nav-link" data-page="games" onclick="navigateTo('games')">
       üéÆ Games
      </div>
      <div class="nav-link" data-page="grammar" onclick="navigateTo('grammar')">
       ‚úçÔ∏è Grammar
      </div>
      <div class="nav-link" data-page="tournament" onclick="navigateTo('tournament')">
       üèÜ Tournament
      </div>
      <div class="nav-link" data-page="profile" onclick="navigateTo('profile')">
       üë§ Profile
      </div>
     </nav>
     <div style="display: flex; gap: 12px; align-items: center; min-width: 180px;">
      <div class="xp-badge">
       ‚≠ê <span id="xp-display">0</span> XP
      </div>
      <div class="xp-badge" style="background: linear-gradient(135deg, #ff6b6b, #ff8787);">
       üî• <span id="streak-display">0</span>
      </div>
     </div>
    </header><!-- Content -->
    <div class="content" id="content"></div>
   </div><!-- Explanation Modal -->
   <div id="explanation-modal" class="modal">
    <div class="modal-content">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="font-weight: 900; font-size: 20px;">üìö Explanation</h2><button class="btn btn-danger" style="padding: 6px 12px;" onclick="closeExplanationModal()">‚úï</button>
     </div>
     <div id="explanation-content"></div>
    </div>
   </div>
  </div>
  <script>
// ===== EXPANDED VOCABULARY DATABASE =====
const VOCABULARY_DATA = {
  A1: [
    { word: 'cat', meaning: '‡πÅ‡∏°‡∏ß', example: 'I have a cat', level: 'A1' },
    { word: 'dog', meaning: '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç', example: 'The dog is friendly', level: 'A1' },
    { word: 'eat', meaning: '‡∏Å‡∏¥‡∏ô', example: 'I eat rice every day', level: 'A1' },
    { word: 'sleep', meaning: '‡∏ô‡∏≠‡∏ô', example: 'I sleep at night', level: 'A1' },
    { word: 'happy', meaning: '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç', example: 'I am happy today', level: 'A1' },
    { word: 'run', meaning: '‡∏ß‡∏¥‡πà‡∏á', example: 'The boy runs in the park', level: 'A1' },
    { word: 'jump', meaning: '‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î', example: 'Children jump in the playground', level: 'A1' },
    { word: 'walk', meaning: '‡πÄ‡∏î‡∏¥‡∏ô', example: 'She walks to school', level: 'A1' },
    { word: 'read', meaning: '‡∏≠‡πà‡∏≤‡∏ô', example: 'I read a book every night', level: 'A1' },
    { word: 'write', meaning: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô', example: 'He writes letters', level: 'A1' },
    { word: 'book', meaning: '‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', example: 'This book is interesting', level: 'A1' },
    { word: 'apple', meaning: '‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡∏•', example: 'I like red apples', level: 'A1' },
    { word: 'orange', meaning: '‡∏™‡πâ‡∏°', example: 'Oranges are sweet', level: 'A1' },
    { word: 'water', meaning: '‡∏ô‡πâ‡∏≥', example: 'Drink water every day', level: 'A1' },
    { word: 'milk', meaning: '‡∏ô‡∏°', example: 'Children drink milk', level: 'A1' },
    { word: 'house', meaning: '‡∏ö‡πâ‡∏≤‡∏ô', example: 'My house is big', level: 'A1' },
    { word: 'school', meaning: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', example: 'I go to school', level: 'A1' },
    { word: 'teacher', meaning: '‡∏Ñ‡∏£‡∏π', example: 'My teacher is kind', level: 'A1' },
    { word: 'student', meaning: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', example: 'Students study hard', level: 'A1' },
    { word: 'mother', meaning: '‡πÅ‡∏°‡πà', example: 'My mother loves me', level: 'A1' },
    { word: 'father', meaning: '‡∏û‡πà‡∏≠', example: 'My father is tall', level: 'A1' },
    { word: 'sister', meaning: '‡∏ô‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏ß/‡∏û‡∏µ‡πà‡∏™‡∏≤‡∏ß', example: 'My sister is beautiful', level: 'A1' },
    { word: 'brother', meaning: '‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏≤‡∏¢/‡∏û‡∏µ‡πà‡∏ä‡∏≤‡∏¢', example: 'My brother plays football', level: 'A1' },
    { word: 'friend', meaning: '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô', example: 'She is my best friend', level: 'A1' },
    { word: 'red', meaning: '‡πÅ‡∏î‡∏á', example: 'I like red color', level: 'A1' },
    { word: 'blue', meaning: '‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', example: 'The sky is blue', level: 'A1' },
    { word: 'green', meaning: '‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', example: 'The grass is green', level: 'A1' },
    { word: 'black', meaning: '‡∏™‡∏µ‡∏î‡∏≥', example: 'He wears black shoes', level: 'A1' },
    { word: 'white', meaning: '‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß', example: 'Snow is white', level: 'A1' },
    { word: 'big', meaning: '‡πÉ‡∏´‡∏ç‡πà', example: 'This elephant is very big', level: 'A1' },
    { word: 'small', meaning: '‡πÄ‡∏•‡πá‡∏Å', example: 'The mouse is small', level: 'A1' },
    { word: 'good', meaning: '‡∏î‡∏µ', example: 'This is good food', level: 'A1' },
    { word: 'bad', meaning: '‡πÑ‡∏°‡πà‡∏î‡∏µ', example: 'That idea is bad', level: 'A1' },
    { word: 'hot', meaning: '‡∏£‡πâ‡∏≠‡∏ô', example: 'The weather is hot', level: 'A1' },
    { word: 'cold', meaning: '‡πÄ‡∏¢‡πá‡∏ô', example: 'Ice cream is cold', level: 'A1' },
    { word: 'one', meaning: '‡∏´‡∏ô‡∏∂‡πà‡∏á', example: 'I have one car', level: 'A1' },
    { word: 'two', meaning: '‡∏™‡∏≠‡∏á', example: 'I have two eyes', level: 'A1' },
    { word: 'three', meaning: '‡∏™‡∏≤‡∏°', example: 'There are three birds', level: 'A1' },
    { word: 'ten', meaning: '‡∏™‡∏¥‡∏ö', example: 'I have ten fingers', level: 'A1' },
    { word: 'hundred', meaning: '‡∏£‡πâ‡∏≠‡∏¢', example: 'One hundred people came', level: 'A1' },
    { word: 'come', meaning: '‡∏°‡∏≤', example: 'Come here please', level: 'A1' },
    { word: 'go', meaning: '‡πÑ‡∏õ', example: 'I go to work', level: 'A1' },
    { word: 'play', meaning: '‡πÄ‡∏•‡πà‡∏ô', example: 'Children play in the park', level: 'A1' },
    { word: 'work', meaning: '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', example: 'He works hard', level: 'A1' },
    { word: 'rest', meaning: '‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô', example: 'I rest on Sunday', level: 'A1' },
    { word: 'smile', meaning: '‡∏¢‡∏¥‡πâ‡∏°', example: 'She smiles at me', level: 'A1' },
    { word: 'cry', meaning: '‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ', example: 'The baby cries', level: 'A1' },
    { word: 'laugh', meaning: '‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏∞', example: 'We all laugh together', level: 'A1' },
    { word: 'sing', meaning: '‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á', example: 'She sings beautifully', level: 'A1' },
    { word: 'dance', meaning: '‡πÄ‡∏ï‡πâ‡∏ô', example: 'They dance at the party', level: 'A1' },
  ],
  A2: [
    { word: 'enjoy', meaning: '‡∏ä‡∏≠‡∏ö/‡∏™‡∏ô‡∏∏‡∏Å', example: 'I enjoy playing football', level: 'A2' },
    { word: 'believe', meaning: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠', example: 'I believe in you', level: 'A2' },
    { word: 'support', meaning: '‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô', example: 'I support your dream', level: 'A2' },
    { word: 'understand', meaning: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à', example: 'Do you understand me?', level: 'A2' },
    { word: 'remember', meaning: '‡∏à‡∏≥‡πÑ‡∏î‡πâ', example: 'I remember that day', level: 'A2' },
    { word: 'forget', meaning: '‡∏•‡∏∑‡∏°', example: 'I forget my keys', level: 'A2' },
    { word: 'learn', meaning: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ', example: 'We learn English at school', level: 'A2' },
    { word: 'teach', meaning: '‡∏™‡∏≠‡∏ô', example: 'She teaches math', level: 'A2' },
    { word: 'begin', meaning: '‡πÄ‡∏£‡∏¥‡πà‡∏°', example: 'The class begins at 8', level: 'A2' },
    { word: 'end', meaning: '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', example: 'The movie ends at 10', level: 'A2' },
    { word: 'continue', meaning: '‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á', example: 'Please continue reading', level: 'A2' },
    { word: 'stop', meaning: '‡∏´‡∏¢‡∏∏‡∏î', example: 'Stop the car', level: 'A2' },
    { word: 'start', meaning: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', example: 'Start your engine', level: 'A2' },
    { word: 'finish', meaning: '‡πÄ‡∏™‡∏£‡πá‡∏à', example: 'I finish my homework', level: 'A2' },
    { word: 'happen', meaning: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô', example: 'What happened?', level: 'A2' },
    { word: 'change', meaning: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô', example: 'I want to change my job', level: 'A2' },
    { word: 'improve', meaning: '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á', example: 'We need to improve', level: 'A2' },
    { word: 'help', meaning: '‡∏ä‡πà‡∏ß‡∏¢', example: 'Can you help me?', level: 'A2' },
    { word: 'try', meaning: '‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°', example: 'Try your best', level: 'A2' },
    { word: 'succeed', meaning: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', example: 'You will succeed', level: 'A2' },
    { word: 'fail', meaning: '‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', example: 'Do not fail', level: 'A2' },
    { word: 'win', meaning: '‡∏ä‡∏ô‡∏∞', example: 'Our team will win', level: 'A2' },
    { word: 'lose', meaning: '‡πÅ‡∏û‡πâ', example: 'We lost the game', level: 'A2' },
    { word: 'know', meaning: '‡∏£‡∏π‡πâ', example: 'I know that person', level: 'A2' },
    { word: 'think', meaning: '‡∏Ñ‡∏¥‡∏î', example: 'What do you think?', level: 'A2' },
    { word: 'want', meaning: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£', example: 'I want a new car', level: 'A2' },
    { word: 'need', meaning: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£/‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏µ', example: 'I need your help', level: 'A2' },
    { word: 'like', meaning: '‡∏ä‡∏≠‡∏ö', example: 'I like ice cream', level: 'A2' },
    { word: 'love', meaning: '‡∏£‡∏±‡∏Å', example: 'I love my family', level: 'A2' },
    { word: 'hate', meaning: '‡πÄ‡∏Å‡∏•‡∏µ‡∏¢‡∏î', example: 'I hate spam', level: 'A2' },
  ]
};

// ===== AI GRAMMAR CHECKER DATABASE =====
const GRAMMAR_RULES = [
  {
    name: 'Subject-Verb Agreement (I)',
    test: (text) => /\bI\s+(?:is|are|was|were|has|have|do|does)/gi.test(text),
    pattern: /I\s+(is|are)/gi,
    fix: (text) => text.replace(/I\s+is/gi, 'I am').replace(/I\s+are/gi, 'I am'),
    explanation: 'I always uses "am" (present), "was" (past), "have", "do". Examples:\n‚Ä¢ I am happy\n‚Ä¢ I was tired\n‚Ä¢ I have a pen\n‚Ä¢ I do understand'
  },
  {
    name: 'Subject-Verb Agreement (He/She/It)',
    test: (text) => /\b(he|she|it)\s+(?:am|are|have|do)\b/gi.test(text),
    pattern: /\b(he|she|it)\s+(am|are|have|do)\b/gi,
    fix: (text) => text.replace(/(he|she|it)\s+(am|are|have|do)\b/gi, '$1 is/has/does'),
    explanation: 'He/She/It uses "is" (present), "was" (past), "has", "does". Examples:\n‚Ä¢ He is tall\n‚Ä¢ She is a teacher\n‚Ä¢ It has a tail\n‚Ä¢ He does homework'
  },
  {
    name: 'Article Usage (A/An)',
    test: (text) => /\ba\s+[aeiou]/gi.test(text),
    pattern: /\ba\s+([aeiou])/gi,
    fix: (text) => text.replace(/\ba\s+([aeiou])/gi, 'an $1'),
    explanation: 'Use "an" before vowel sounds, "a" before consonants:\n‚Ä¢ a cat, a dog\n‚Ä¢ an apple, an orange\n‚Ä¢ an elephant, an idea'
  },
  {
    name: 'Plural Form (S)',
    test: (text) => /\b(student|book|apple|cat|dog)\s+(is|are)\b/gi.test(text),
    pattern: /\b(student|book|apple|cat|dog)\s+is\b/gi,
    fix: (text) => text.replace(/\b(student|book|apple|cat|dog)\s+is\b/gi, '$1s are'),
    explanation: 'Plural nouns use "are" not "is":\n‚Ä¢ The cat is black (singular)\n‚Ä¢ The cats are black (plural)\n‚Ä¢ One book is here / Two books are here'
  },
  {
    name: 'Word Order (Questions)',
    test: (text) => /^[a-z]+(you|he|she|it|I|we|they)\s+/gmi.test(text),
    pattern: null,
    fix: null,
    explanation: 'Question word order: Verb + Subject\n‚Ä¢ Are you happy? (NOT: You are happy?)\n‚Ä¢ Does he like pizza? (NOT: He does like pizza?)\n‚Ä¢ Can she swim? (NOT: She can swim?)'
  },
  {
    name: 'Spelling - Common Words',
    test: (text) => /\b(recieve|occured|seperate|writting|hopping|stoping)\b/gi.test(text),
    pattern: /\b(recieve|occured|seperate|writting|hopping|stoping)\b/gi,
    fix: (text) => text
      .replace(/recieve/gi, 'receive')
      .replace(/occured/gi, 'occurred')
      .replace(/seperate/gi, 'separate')
      .replace(/writting/gi, 'writing')
      .replace(/hopping/gi, 'hoping')
      .replace(/stoping/gi, 'stopping'),
    explanation: 'Common spelling mistakes:\n‚Ä¢ receive (not recieve) - "i before e except after c"\n‚Ä¢ occurred (not occured) - double C and R\n‚Ä¢ separate (not seperate) - "there is A in separate"\n‚Ä¢ writing (not writting) - drop E before -ing\n‚Ä¢ hoping (not hopping) - drop E before -ing'
  },
  {
    name: 'Capitalization',
    test: (text) => /[.!?]\s+[a-z]/.test(text),
    pattern: /[.!?]\s+([a-z])/g,
    fix: (text) => text.replace(/[.!?]\s+([a-z])/g, (match) => match.replace(/(.)(.)/, '$1' + match[match.length-1].toUpperCase())),
    explanation: 'Capitalize first letter after period, question mark, exclamation:\n‚Ä¢ I like apples. They are sweet. (NOT: They are sweet)\n‚Ä¢ Do you like cats? I do. (NOT: i do)'
  },
  {
    name: 'Present Continuous (Is/Are + -ing)',
    test: (text) => /\b(am|is|are)\s+(?!.*ing\b)/i.test(text) && /\b(am|is|are)\b/i.test(text),
    pattern: null,
    fix: null,
    explanation: 'Present continuous uses: be verb + -ing\n‚Ä¢ I am reading\n‚Ä¢ He is playing\n‚Ä¢ They are eating\n‚Ä¢ She is studying'
  },
  {
    name: 'Past Tense (-ed)',
    test: (text) => /yesterday|last|ago/.test(text) && !/ed\b/.test(text),
    pattern: null,
    fix: null,
    explanation: 'Past tense with regular verbs add -ed:\n‚Ä¢ I walked to school\n‚Ä¢ She played football\n‚Ä¢ They worked hard\n‚Ä¢ He finished his homework'
  },
  {
    name: 'Double Consonant Before -ing',
    test: (text) => /\b(stop|hop|run|sit|swim|plan|get|put)ing\b/gi.test(text),
    pattern: /\b(stop|hop|run|sit|swim|plan|get|put)ing\b/gi,
    fix: (text) => text
      .replace(/stoping/gi, 'stopping')
      .replace(/hoping/gi, 'hopping')
      .replace(/runing/gi, 'running')
      .replace(/siting/gi, 'sitting')
      .replace(/swiming/gi, 'swimming')
      .replace(/planing/gi, 'planning')
      .replace(/geting/gi, 'getting')
      .replace(/puting/gi, 'putting'),
    explanation: 'Double consonant when: short vowel + single consonant + -ing\n‚Ä¢ stop ‚Üí stopping\n‚Ä¢ run ‚Üí running\n‚Ä¢ sit ‚Üí sitting\n‚Ä¢ swim ‚Üí swimming'
  }
];

let allUsers = [];
let currentUser = null;
let currentPage = 'home';
let gameState = { questions: [], current: 0, score: 0, results: [], selectedAnswer: null };

function showPage(html) {
  document.getElementById('content').innerHTML = html;
  document.getElementById('content').scrollTop = 0;
}

function navigateTo(page) {
  currentPage = page;
  document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
  document.querySelector(`[data-page="${page}"]`)?.classList.add('active');

  switch(page) {
    case 'home': renderHome(); break;
    case 'games': renderGames(); break;
    case 'grammar': renderGrammar(); break;
    case 'tournament': renderTournament(); break;
    case 'profile': renderProfile(); break;
  }
}

function renderHome() {
  const xp = currentUser.total_xp || 0;
  const streak = currentUser.daily_streak || 0;
  const correct = currentUser.correct_answers || 0;
  const wrong = currentUser.wrong_answers || 0;
  const accuracy = (correct + wrong) > 0 ? Math.round((correct / (correct + wrong)) * 100) : 0;

  let adminPanel = '';
  if (currentUser.username === 'admin') {
    adminPanel = `
      <div class="admin-panel">
        <h3 style="margin-bottom: 12px; font-weight: 900;">üõ†Ô∏è ADMIN PANEL</h3>
        <button class="btn btn-danger" style="width: 100%; padding: 10px;" onclick="clearAllUserData()">‚ö†Ô∏è DELETE ALL USER DATA</button>
        <div style="margin-top: 8px; font-size: 12px; opacity: 0.9;">Total Users: ${allUsers.filter(u => u.type === 'user').length}</div>
      </div>
    `;
  }

  showPage(`
    <div style="padding: 30px; max-width: 1200px; margin: 0 auto;">
      ${adminPanel}
      
      <h2 style="font-size: 32px; margin-bottom: 20px; font-weight: 900;">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${currentUser.display_name}! üéì</h2>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 30px;">
        <div class="card" style="text-align: center;">
          <div style="font-size: 36px; margin-bottom: 8px;">‚≠ê</div>
          <div style="font-size: 22px; color: #667eea; font-weight: 900;">${xp}</div>
          <div style="opacity: 0.6; font-size: 11px;">Total XP</div>
        </div>
        <div class="card" style="text-align: center;">
          <div style="font-size: 36px; margin-bottom: 8px;">üî•</div>
          <div style="font-size: 22px; color: #ff6b6b; font-weight: 900;">${streak}</div>
          <div style="opacity: 0.6; font-size: 11px;">Streak</div>
        </div>
        <div class="card" style="text-align: center;">
          <div style="font-size: 36px; margin-bottom: 8px;">‚úÖ</div>
          <div style="font-size: 22px; color: #51cf66; font-weight: 900;">${correct}</div>
          <div style="opacity: 0.6; font-size: 11px;">Correct</div>
        </div>
        <div class="card" style="text-align: center;">
          <div style="font-size: 36px; margin-bottom: 8px;">‚ùå</div>
          <div style="font-size: 22px; color: #ff6b6b; font-weight: 900;">${wrong}</div>
          <div style="opacity: 0.6; font-size: 11px;">Wrong</div>
        </div>
        <div class="card" style="text-align: center;">
          <div style="font-size: 36px; margin-bottom: 8px;">üìä</div>
          <div style="font-size: 22px; color: #667eea; font-weight: 900;">${accuracy}%</div>
          <div style="opacity: 0.6; font-size: 11px;">Accuracy</div>
        </div>
      </div>

      <h3 style="font-weight: 700; margin-bottom: 15px; font-size: 18px;">üéÆ Quick Access</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
        <div class="card" style="cursor: pointer; padding: 20px; text-align: center;" onclick="navigateTo('games')">
          <div style="font-size: 40px; margin-bottom: 10px;">üéØ</div>
          <h4 style="font-weight: 700; font-size: 14px;">Play Games</h4>
        </div>
        <div class="card" style="cursor: pointer; padding: 20px; text-align: center;" onclick="navigateTo('grammar')">
          <div style="font-size: 40px; margin-bottom: 10px;">‚úçÔ∏è</div>
          <h4 style="font-weight: 700; font-size: 14px;">Grammar Check</h4>
        </div>
        <div class="card" style="cursor: pointer; padding: 20px; text-align: center;" onclick="navigateTo('tournament')">
          <div style="font-size: 40px; margin-bottom: 10px;">üèÜ</div>
          <h4 style="font-weight: 700; font-size: 14px;">Tournament</h4>
        </div>
        <div class="card" style="cursor: pointer; padding: 20px; text-align: center;" onclick="navigateTo('profile')">
          <div style="font-size: 40px; margin-bottom: 10px;">üë§</div>
          <h4 style="font-weight: 700; font-size: 14px;">Profile</h4>
        </div>
      </div>
    </div>
  `);
}

async function clearAllUserData() {
  if (!confirm('‚ö†Ô∏è WARNING: This will DELETE ALL user data forever! Are you sure?')) return;

  for (const user of allUsers.filter(u => u.type === 'user')) {
    const result = await window.dataSdk.delete(user);
    if (!result.isOk) {
      alert('Error deleting user: ' + result.error);
      return;
    }
  }

  alert('‚úÖ All user data deleted!');
  navigateTo('home');
}

function renderGames() {
  showPage(`
    <div style="padding: 30px; max-width: 1000px; margin: 0 auto;">
      <h2 style="font-size: 32px; margin-bottom: 20px; font-weight: 900;">üéÆ Learning Games</h2>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
        <div class="card" style="cursor: pointer; padding: 25px; text-align: center;" onclick="startGame('reading')">
          <div style="font-size: 48px; margin-bottom: 12px;">üìñ</div>
          <h4 style="font-weight: 700;">Reading Quiz</h4>
          <div style="color: #667eea; font-weight: 900; margin-top: 8px;">+50 XP</div>
          <div style="opacity: 0.6; font-size: 12px;">50+ Questions</div>
        </div>

        <div class="card" style="cursor: pointer; padding: 25px; text-align: center;" onclick="startGame('typing')">
          <div style="font-size: 48px; margin-bottom: 12px;">‚å®Ô∏è</div>
          <h4 style="font-weight: 700;">Typing Challenge</h4>
          <div style="color: #667eea; font-weight: 900; margin-top: 8px;">+75 XP</div>
          <div style="opacity: 0.6; font-size: 12px;">50+ Questions</div>
        </div>

        <div class="card" style="cursor: pointer; padding: 25px; text-align: center;" onclick="startGame('multiple-choice')">
          <div style="font-size: 48px; margin-bottom: 12px;">‚ùì</div>
          <h4 style="font-weight: 700;">Multiple Choice</h4>
          <div style="color: #667eea; font-weight: 900; margin-top: 8px;">+60 XP</div>
          <div style="opacity: 0.6; font-size: 12px;">50+ Questions</div>
        </div>

        <div class="card" style="cursor: pointer; padding: 25px; text-align: center;" onclick="startGame('matching')">
          <div style="font-size: 48px; margin-bottom: 12px;">üéØ</div>
          <h4 style="font-weight: 700;">Matching</h4>
          <div style="color: #667eea; font-weight: 900; margin-top: 8px;">+55 XP</div>
          <div style="opacity: 0.6; font-size: 12px;">50+ Questions</div>
        </div>

        <div class="card" style="cursor: pointer; padding: 25px; text-align: center;" onclick="startGame('flashcard')">
          <div style="font-size: 48px; margin-bottom: 12px;">üé¥</div>
          <h4 style="font-weight: 700;">Flashcard</h4>
          <div style="color: #667eea; font-weight: 900; margin-top: 8px;">+40 XP</div>
          <div style="opacity: 0.6; font-size: 12px;">50+ Questions</div>
        </div>

        <div class="card" style="cursor: pointer; padding: 25px; text-align: center;" onclick="startGame('listening')">
          <div style="font-size: 48px; margin-bottom: 12px;">üéß</div>
          <h4 style="font-weight: 700;">Listening</h4>
          <div style="color: #667eea; font-weight: 900; margin-top: 8px;">+80 XP</div>
          <div style="opacity: 0.6; font-size: 12px;">50+ Questions</div>
        </div>
      </div>
    </div>
  `);
}

function generateAIQuestions(type, count) {
  const allVocab = [...VOCABULARY_DATA.A1, ...VOCABULARY_DATA.A2];
  const questions = [];
  const usedIndices = new Set();

  for (let i = 0; i < count; i++) {
    let randomIdx;
    do {
      randomIdx = Math.floor(Math.random() * allVocab.length);
    } while (usedIndices.has(randomIdx) && usedIndices.size < allVocab.length);
    usedIndices.add(randomIdx);

    const word = allVocab[randomIdx];
    
    if (type === 'reading') {
      const wrongMeanings = allVocab
        .filter((_, idx) => idx !== randomIdx)
        .sort(() => 0.5 - Math.random())
        .slice(0, 3)
        .map(w => w.meaning);

      questions.push({
        type: 'reading',
        sentence: word.example,
        word: word.word,
        meaning: word.meaning,
        level: word.level,
        options: shuffle([word.meaning, ...wrongMeanings])
      });
    } else if (type === 'typing') {
      questions.push({
        type: 'typing',
        meaning: word.meaning,
        word: word.word,
        example: word.example,
        level: word.level
      });
    } else if (type === 'multiple-choice') {
      const wrongMeanings = allVocab
        .filter((_, idx) => idx !== randomIdx)
        .sort(() => 0.5 - Math.random())
        .slice(0, 3)
        .map(w => w.meaning);

      questions.push({
        type: 'multiple-choice',
        word: word.word,
        meaning: word.meaning,
        level: word.level,
        options: shuffle([word.meaning, ...wrongMeanings])
      });
    } else if (type === 'listening') {
      const wrongWords = allVocab
        .filter((_, idx) => idx !== randomIdx)
        .sort(() => 0.5 - Math.random())
        .slice(0, 3)
        .map(w => w.word);

      questions.push({
        type: 'listening',
        word: word.word,
        meaning: word.meaning,
        example: word.example,
        level: word.level,
        options: shuffle([word.word, ...wrongWords])
      });
    }
  }
  
  return questions;
}

function startGame(gameType) {
  const questions = generateAIQuestions(gameType, 5);
  gameState = {
    type: gameType,
    questions: questions,
    current: 0,
    score: 0,
    results: [],
    selectedAnswer: null
  };

  if (gameType === 'reading') showReadingQuestion();
  else if (gameType === 'typing') showTypingQuestion();
  else if (gameType === 'multiple-choice') showMultipleChoiceQuestion();
  else if (gameType === 'matching') showMatchingGame();
  else if (gameType === 'flashcard') showFlashcardGame();
  else if (gameType === 'listening') showListeningQuestion();
}

function showReadingQuestion() {
  const q = gameState.questions[gameState.current];
  if (!q) { finishGame(); return; }

  const progress = Math.round(((gameState.current) / gameState.questions.length) * 100);

  showPage(`
    <div style="padding: 30px; max-width: 700px; margin: 0 auto;">
      <div style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
          <span style="opacity: 0.6;">Q${gameState.current + 1}/${gameState.questions.length}</span>
          <span style="font-weight: 700; color: #667eea;">Score: ${gameState.score}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%;"></div>
        </div>
      </div>

      <div class="card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin-bottom: 20px;">
        <div style="font-size: 18px; margin-bottom: 12px;">üìñ Read this sentence:</div>
        <p style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">"${q.sentence}"</p>
        <div style="font-size: 14px; opacity: 0.9;">What does "<span style="color: #ffd700; font-weight: 900;">${q.word}</span>" mean?</div>
        <div style="margin-top: 8px; opacity: 0.8; font-size: 12px;"><span class="level-badge" style="background: rgba(255,255,255,0.2); color: white; border-color: white;">${q.level}</span></div>
      </div>

      <div style="margin-bottom: 20px;">
        ${q.options.map((opt, i) => `
          <div class="answer-card ${gameState.selectedAnswer === i ? 'selected' : ''}" onclick="selectReadingOption(${i}, '${q.meaning}')">
            ${opt}
          </div>
        `).join('')}
      </div>

      <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="nextQuestion(false)">Skip</button>
        <button class="btn btn-primary" style="flex: 1;" onclick="nextQuestion(true)">Next ‚ûú</button>
      </div>
    </div>
  `);
}

function selectReadingOption(index, correct) {
  gameState.selectedAnswer = index;
  const answer = gameState.questions[gameState.current].options[index];
  
  if (answer === correct) {
    gameState.score += 50;
    gameState.results.push({ q: gameState.current + 1, correct: true });
  } else {
    gameState.results.push({ q: gameState.current + 1, correct: false, answer: answer, correctAnswer: correct });
  }
  
  showReadingQuestion();
}

function showTypingQuestion() {
  const q = gameState.questions[gameState.current];
  if (!q) { finishGame(); return; }

  const progress = Math.round(((gameState.current) / gameState.questions.length) * 100);

  showPage(`
    <div style="padding: 30px; max-width: 700px; margin: 0 auto;">
      <div style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
          <span style="opacity: 0.6;">Q${gameState.current + 1}/${gameState.questions.length}</span>
          <span style="font-weight: 700; color: #667eea;">Score: ${gameState.score}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%;"></div>
        </div>
      </div>

      <div class="card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin-bottom: 20px;">
        <div style="font-size: 18px; margin-bottom: 12px;">‚úçÔ∏è Type the word:</div>
        <p style="font-size: 22px; font-weight: 900; margin-bottom: 16px;">${q.meaning}</p>
        <div style="font-size: 13px; opacity: 0.85;">Example: "${q.example}"</div>
        <div style="margin-top: 12px; opacity: 0.8;"><span class="level-badge" style="background: rgba(255,255,255,0.2); color: white; border-color: white;">${q.level}</span></div>
      </div>

      <div style="margin-bottom: 20px;">
        <input type="text" id="typing-input" class="input" placeholder="Type the word..." onkeydown="if(event.key==='Enter') checkTyping('${q.word}')">
      </div>

      <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="nextQuestion(false)">Skip</button>
        <button class="btn btn-primary" style="flex: 1;" onclick="checkTyping('${q.word}')">Check ‚úì</button>
      </div>
    </div>
  `);
  
  setTimeout(() => document.getElementById('typing-input').focus(), 100);
}

function checkTyping(correct) {
  const input = document.getElementById('typing-input').value.toLowerCase().trim();
  
  if (input === correct.toLowerCase()) {
    gameState.score += 75;
    gameState.results.push({ q: gameState.current + 1, correct: true });
  } else {
    gameState.results.push({ q: gameState.current + 1, correct: false, answer: input, correctAnswer: correct });
  }
  
  nextQuestion(true);
}

function showMultipleChoiceQuestion() {
  const q = gameState.questions[gameState.current];
  if (!q) { finishGame(); return; }

  const progress = Math.round(((gameState.current) / gameState.questions.length) * 100);

  showPage(`
    <div style="padding: 30px; max-width: 700px; margin: 0 auto;">
      <div style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
          <span style="opacity: 0.6;">Q${gameState.current + 1}/${gameState.questions.length}</span>
          <span style="font-weight: 700; color: #667eea;">Score: ${gameState.score}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%;"></div>
        </div>
      </div>

      <div class="card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin-bottom: 20px;">
        <div style="font-size: 16px; margin-bottom: 12px;">‚ùì What is the meaning?</div>
        <p style="font-size: 28px; font-weight: 900;">${q.word}</p>
        <div style="margin-top: 12px;"><span class="level-badge" style="background: rgba(255,255,255,0.2); color: white; border-color: white;">${q.level}</span></div>
      </div>

      <div style="margin-bottom: 20px;">
        ${q.options.map((opt, i) => `
          <div class="answer-card ${gameState.selectedAnswer === i ? 'selected' : ''}" onclick="selectMCOption(${i}, '${q.meaning}')">
            ${opt}
          </div>
        `).join('')}
      </div>

      <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="nextQuestion(false)">Skip</button>
        <button class="btn btn-primary" style="flex: 1;" onclick="nextQuestion(true)">Next ‚ûú</button>
      </div>
    </div>
  `);
}

function selectMCOption(index, correct) {
  gameState.selectedAnswer = index;
  const answer = gameState.questions[gameState.current].options[index];
  
  if (answer === correct) {
    gameState.score += 60;
    gameState.results.push({ q: gameState.current + 1, correct: true });
  } else {
    gameState.results.push({ q: gameState.current + 1, correct: false, answer: answer, correctAnswer: correct });
  }
  
  showMultipleChoiceQuestion();
}

function showFlashcardGame() {
  const q = gameState.questions[gameState.current];
  if (!q) { finishGame(); return; }

  const progress = Math.round(((gameState.current) / gameState.questions.length) * 100);

  showPage(`
    <div style="padding: 30px; max-width: 700px; margin: 0 auto;">
      <div style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
          <span style="opacity: 0.6;">Card ${gameState.current + 1}/${gameState.questions.length}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%;"></div>
        </div>
      </div>

      <div class="card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; margin-bottom: 20px;" id="flashcard-flip" onclick="flipCard()" data-flipped="0">
        <div style="font-size: 18px; opacity: 0.9; margin-bottom: 16px;">‚¨ÖÔ∏è Click to flip</div>
        <div style="font-size: 32px; font-weight: 900;">${q.word}</div>
      </div>

      <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="nextQuestion(false)">Previous</button>
        <button class="btn btn-primary" style="flex: 1;" onclick="nextQuestion(true)">Next ‚ûú</button>
      </div>
    </div>
  `);
}

function flipCard() {
  const card = document.getElementById('flashcard-flip');
  const isFlipped = card.dataset.flipped === '1';
  const q = gameState.questions[gameState.current];
  
  if (isFlipped) {
    card.innerHTML = `
      <div style="font-size: 18px; opacity: 0.9; margin-bottom: 16px;">‚¨ÖÔ∏è Click to flip</div>
      <div style="font-size: 32px; font-weight: 900;">${q.word}</div>
    `;
    card.dataset.flipped = '0';
  } else {
    card.innerHTML = `
      <div style="font-size: 18px; opacity: 0.9; margin-bottom: 16px;">‚¨ÖÔ∏è Click to flip</div>
      <div style="font-size: 32px; font-weight: 900;">${q.meaning}</div>
    `;
    card.dataset.flipped = '1';
  }
}

function showMatchingGame() {
  const questions = gameState.questions.slice(0, 4);
  
  showPage(`
    <div style="padding: 30px; max-width: 900px; margin: 0 auto;">
      <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 20px;">üéØ Match Words with Meanings</h2>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div>
          <h3 style="font-weight: 700; margin-bottom: 15px;">Words</h3>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            ${questions.map((q, i) => `
              <div class="card" style="cursor: pointer; padding: 16px; text-align: center; font-weight: 700; font-size: 16px;" onclick="selectWord(${i})">
                ${q.word}
              </div>
            `).join('')}
          </div>
        </div>

        <div>
          <h3 style="font-weight: 700; margin-bottom: 15px;">Meanings</h3>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            ${shuffle(questions).map((q, i) => `
              <div class="card" style="cursor: pointer; padding: 16px; text-align: center; font-weight: 700; font-size: 16px;" onclick="selectMeaning(${i}, '${q.meaning}')">
                ${q.meaning}
              </div>
            `).join('')}
          </div>
        </div>
      </div>

      <button class="btn btn-secondary" style="width: 100%; margin-top: 30px;" onclick="finishGame()">Done</button>
    </div>
  `);
}

function showListeningQuestion() {
  const q = gameState.questions[gameState.current];
  if (!q) { finishGame(); return; }

  const progress = Math.round(((gameState.current) / gameState.questions.length) * 100);

  showPage(`
    <div style="padding: 30px; max-width: 700px; margin: 0 auto;">
      <div style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
          <span style="opacity: 0.6;">Q${gameState.current + 1}/${gameState.questions.length}</span>
          <span style="font-weight: 700; color: #667eea;">Score: ${gameState.score}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%;"></div>
        </div>
      </div>

      <div class="card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 40px; text-align: center; margin-bottom: 20px;">
        <div style="font-size: 60px; margin-bottom: 16px;">üéß</div>
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">Listen to the pronunciation</div>
        <button class="btn btn-success" style="background: white; color: #667eea; font-weight: 900;" onclick="speakWord('${q.word}')">üîä Play Audio</button>
        <div style="margin-top: 16px; opacity: 0.8; font-size: 12px;"><span class="level-badge" style="background: rgba(255,255,255,0.2); color: white; border-color: white;">${q.level}</span></div>
      </div>

      <div style="margin-bottom: 20px;">
        ${q.options.map((opt, i) => `
          <div class="answer-card ${gameState.selectedAnswer === i ? 'selected' : ''}" onclick="selectListeningOption(${i}, '${q.word}')">
            ${opt}
          </div>
        `).join('')}
      </div>

      <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="nextQuestion(false)">Skip</button>
        <button class="btn btn-primary" style="flex: 1;" onclick="nextQuestion(true)">Next ‚ûú</button>
      </div>
    </div>
  `);
}

function speakWord(word) {
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.lang = 'en-US';
    utterance.rate = 0.8;
    speechSynthesis.speak(utterance);
  }
}

function selectListeningOption(index, correct) {
  gameState.selectedAnswer = index;
  const answer = gameState.questions[gameState.current].options[index];
  
  if (answer === correct) {
    gameState.score += 80;
    gameState.results.push({ q: gameState.current + 1, correct: true });
  } else {
    gameState.results.push({ q: gameState.current + 1, correct: false, answer: answer, correctAnswer: correct });
  }
  
  showListeningQuestion();
}

function nextQuestion(confirm) {
  gameState.current++;
  gameState.selectedAnswer = null;
  
  if (gameState.current >= gameState.questions.length) {
    finishGame();
  } else if (gameState.type === 'reading') {
    showReadingQuestion();
  } else if (gameState.type === 'typing') {
    showTypingQuestion();
  } else if (gameState.type === 'multiple-choice') {
    showMultipleChoiceQuestion();
  } else if (gameState.type === 'flashcard') {
    showFlashcardGame();
  } else if (gameState.type === 'listening') {
    showListeningQuestion();
  }
}

async function finishGame() {
  const totalXP = gameState.score;
  const correct = gameState.results.filter(r => r.correct).length;
  const wrong = gameState.results.filter(r => !r.correct).length;

  const updates = {
    ...currentUser,
    total_xp: (currentUser.total_xp || 0) + totalXP,
    daily_streak: (currentUser.daily_streak || 0) + 1,
    correct_answers: (currentUser.correct_answers || 0) + correct,
    wrong_answers: (currentUser.wrong_answers || 0) + wrong,
    games_played: (currentUser.games_played || 0) + 1
  };

  const result = await window.dataSdk.update(updates);
  if (result.isOk) {
    currentUser = updates;
    document.getElementById('xp-display').textContent = updates.total_xp;
    document.getElementById('streak-display').textContent = updates.daily_streak;
  }

  const resultsHTML = gameState.results.map((r, i) => `
    <tr>
      <td>#${r.q}</td>
      <td>${r.correct ? '‚úÖ' : '‚ùå'}</td>
      <td>${r.correct ? 'Correct' : r.answer || 'Skipped'}</td>
      <td>${!r.correct ? r.correctAnswer : '-'}</td>
    </tr>
  `).join('');

  showPage(`
    <div style="padding: 30px; max-width: 800px; margin: 0 auto; text-align: center;">
      <div style="font-size: 80px; margin-bottom: 20px;">üéâ</div>
      <h1 style="font-size: 32px; font-weight: 900; margin-bottom: 20px; color: #667eea;">Game Complete!</h1>

      <div class="card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; margin-bottom: 20px; padding: 30px;">
        <div style="font-size: 48px; font-weight: 900; margin-bottom: 12px;">+${totalXP} XP</div>
        <div style="font-size: 18px; margin-bottom: 16px;">Correct: <span style="color: #51cf66; font-weight: 900;">${correct}</span> | Wrong: <span style="color: #ff6b6b; font-weight: 900;">${wrong}</span></div>
      </div>

      <div class="card">
        <h3 style="font-weight: 700; margin-bottom: 15px; text-align: left;">üìä Results</h3>
        <table class="result-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Status</th>
              <th>Your Answer</th>
              <th>Correct Answer</th>
            </tr>
          </thead>
          <tbody>
            ${resultsHTML}
          </tbody>
        </table>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="navigateTo('games')">Play Again</button>
        <button class="btn btn-primary" style="flex: 1;" onclick="navigateTo('home')">Home</button>
      </div>
    </div>
  `);
}

function renderGrammar() {
  showPage(`
    <div style="padding: 30px; max-width: 900px; margin: 0 auto;">
      <h2 style="font-size: 32px; margin-bottom: 20px; font-weight: 900;">‚úçÔ∏è AI Grammar Checker</h2>

      <div class="card" style="background: #e3f2fd; border: 3px solid #667eea; margin-bottom: 20px;">
        <div style="font-weight: 700; color: #1565c0; margin-bottom: 8px;">ü§ñ AI-Powered Grammar Assistance</div>
        <div style="font-size: 14px; color: #0c5460;">Type or paste your English text. Our AI checks: Subject-Verb Agreement ‚Ä¢ A/An Usage ‚Ä¢ Plurals ‚Ä¢ Spelling ‚Ä¢ Word Order ‚Ä¢ Capitalization ‚Ä¢ Tenses</div>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 700; margin-bottom: 8px;">Your Text:</label>
        <textarea id="grammar-input" class="input" style="min-height: 150px; border: 3px solid #333; padding: 16px; font-family: 'Courier Prime', monospace;" placeholder="Type your English text here...

Examples:
‚Ä¢ I is happy today.
‚Ä¢ he go to school
‚Ä¢ a apple is red
‚Ä¢ She don't like pizza.
‚Ä¢ does you understand"></textarea>
      </div>

      <div style="display: flex; gap: 12px; margin-bottom: 30px;">
        <button class="btn btn-primary" style="flex: 1;" onclick="checkGrammar()">ü§ñ Check Grammar</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="document.getElementById('grammar-input').value = ''">Clear</button>
      </div>

      <div id="grammar-result"></div>
    </div>
  `);
}

function checkGrammar() {
  const text = document.getElementById('grammar-input').value.trim();
  
  if (!text) {
    document.getElementById('grammar-result').innerHTML = `<div class="grammar-feedback grammar-wrong">‚ö†Ô∏è Please enter text first!</div>`;
    return;
  }

  const feedback = analyzeGrammar(text);
  
  const resultHTML = `
    <div class="card" style="background: ${feedback.correct ? '#d4edda' : '#f8d7da'}; border: 3px solid ${feedback.correct ? '#28a745' : '#f5c6cb'};">
      <div style="font-weight: 900; font-size: 16px; margin-bottom: 12px;">
        ${feedback.correct ? '‚úÖ Great! No Grammar Issues Found' : '‚ùå Grammar Issues Found'}
      </div>
      <div style="margin-bottom: 12px;">
        <div style="font-weight: 700; margin-bottom: 6px;">Your text:</div>
        <div style="background: white; padding: 12px; border-radius: 4px; font-family: 'Courier Prime', monospace;">
          ${text}
        </div>
      </div>
      ${!feedback.correct ? `
        <div style="margin-bottom: 12px;">
          <div style="font-weight: 700; margin-bottom: 6px;">Suggested:</div>
          <div style="background: white; padding: 12px; border-radius: 4px; font-family: 'Courier Prime', monospace;">
            ${feedback.suggested}
          </div>
        </div>
      ` : ''}
      <div style="margin-bottom: 12px;">
        <div style="font-weight: 700; margin-bottom: 6px;">Issues Found:</div>
        ${feedback.issues.map(issue => `<div class="grammar-issue">${issue}</div>`).join('')}
      </div>
    </div>
  `;
  
  document.getElementById('grammar-result').innerHTML = resultHTML;
}

function analyzeGrammar(text) {
  const issues = [];
  let suggested = text;
  let correct = true;

  GRAMMAR_RULES.forEach(rule => {
    if (rule.test(text)) {
      correct = false;
      issues.push(`<strong>‚ùå ${rule.name}</strong><br>${rule.explanation}`);
      
      if (rule.fix) {
        suggested = rule.fix(text);
      }
    }
  });

  if (!/[.!?]$/.test(text)) {
    correct = false;
    issues.push(`<strong>‚ùå Missing Punctuation</strong><br>Always end sentences with a period (.), question mark (?), or exclamation mark (!)`);
    suggested = text + '.';
  }

  return {
    correct: issues.length === 0,
    suggested: suggested || text,
    issues: issues.length > 0 ? issues : ['‚úì No grammar issues found!']
  };
}

function closeExplanationModal() {
  document.getElementById('explanation-modal').classList.remove('show');
}

function renderTournament() {
  const topPlayers = allUsers
    .filter(u => u.type === 'user')
    .sort((a, b) => (b.total_xp || 0) - (a.total_xp || 0))
    .slice(0, 10);

  const userRank = topPlayers.findIndex(u => u.__backendId === currentUser.__backendId) + 1;

  const leaderboardHTML = topPlayers.map((user, idx) => `
    <div class="tournament-row" style="${user.__backendId === currentUser.__backendId ? 'background: #fff3cd; border: 3px solid #ffc107;' : ''}">
      <div style="font-weight: 900; font-size: 18px; min-width: 40px;">#${idx + 1}</div>
      <div style="flex: 1;">
        <div style="font-weight: 700;">${user.display_name}</div>
        <div style="opacity: 0.6; font-size: 12px;">@${user.username}</div>
      </div>
      <div style="text-align: right;">
        <div style="font-weight: 900; color: #667eea; font-size: 18px;">${user.total_xp || 0}</div>
        <div style="opacity: 0.6; font-size: 11px;">‚≠ê XP</div>
      </div>
      <div style="text-align: right; margin-left: 20px; min-width: 60px;">
        <div style="font-weight: 700; font-size: 14px;">‚úÖ${user.correct_answers || 0}</div>
        <div style="opacity: 0.6; font-size: 11px;">Correct</div>
      </div>
    </div>
  `).join('');

  showPage(`
    <div style="padding: 30px; max-width: 900px; margin: 0 auto;">
      <h2 style="font-size: 32px; margin-bottom: 20px; font-weight: 900;">üèÜ Tournament Leaderboard</h2>

      ${userRank > 0 ? `
        <div class="card" style="background: linear-gradient(135deg, #ffc107, #ff9800); color: white; border: 4px solid #333; margin-bottom: 20px; padding: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 700;">Your Position</div>
              <div style="font-size: 24px; font-weight: 900;">#${userRank} / ${topPlayers.length}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 20px; font-weight: 900;">${currentUser.total_xp || 0} XP</div>
              <div style="font-size: 12px;">Keep playing! üöÄ</div>
            </div>
          </div>
        </div>
      ` : ''}

      <h3 style="font-weight: 700; margin-bottom: 15px; font-size: 18px;">ü•á Top Players</h3>
      ${leaderboardHTML}

      <div style="margin-top: 30px; text-align: center;">
        <button class="btn btn-primary" style="width: 100%; max-width: 300px;" onclick="navigateTo('games')">Play Games to Climb! üéÆ</button>
      </div>
    </div>
  `);
}

async function renderProfile() {
  const xp = currentUser.total_xp || 0;
  const streak = currentUser.daily_streak || 0;
  const correct = currentUser.correct_answers || 0;
  const wrong = currentUser.wrong_answers || 0;
  const accuracy = (correct + wrong) > 0 ? Math.round((correct / (correct + wrong)) * 100) : 0;

  showPage(`
    <div style="padding: 30px; max-width: 700px; margin: 0 auto;">
      <h2 style="font-size: 32px; margin-bottom: 30px; font-weight: 900;">üë§ Profile</h2>

      <div class="card" style="text-align: center; margin-bottom: 30px;">
        <div class="profile-avatar">
          ${currentUser.avatar_url ? `<img src="${currentUser.avatar_url}" alt="Avatar">` : (currentUser.display_name || 'U')[0].toUpperCase()}
        </div>
        <input type="file" id="avatar-upload" style="display: none;" accept="image/*" onchange="uploadAvatar()">
        <button class="btn btn-secondary" style="margin-bottom: 15px; padding: 8px 16px;" onclick="document.getElementById('avatar-upload').click()">üì∑ Upload Avatar</button>
        <h1 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">${currentUser.display_name}</h1>
        <p style="opacity: 0.6;">@${currentUser.username}</p>
      </div>

      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 30px;">
        <div class="card" style="text-align: center;">
          <div style="font-size: 32px; margin-bottom: 8px;">‚≠ê</div>
          <div style="font-size: 22px; font-weight: 900; color: #667eea;">${xp}</div>
          <div style="opacity: 0.6; font-size: 12px;">Total XP</div>
        </div>
        <div class="card" style="text-align: center;">
          <div style="font-size: 32px; margin-bottom: 8px;">üî•</div>
          <div style="font-size: 22px; font-weight: 900; color: #ff6b6b;">${streak}</div>
          <div style="opacity: 0.6; font-size: 12px;">Streak</div>
        </div>
        <div class="card" style="text-align: center;">
          <div style="font-size: 32px; margin-bottom: 8px;">‚úÖ</div>
          <div style="font-size: 22px; font-weight: 900; color: #51cf66;">${correct}</div>
          <div style="opacity: 0.6; font-size: 12px;">Correct</div>
        </div>
        <div class="card" style="text-align: center;">
          <div style="font-size: 32px; margin-bottom: 8px;">üìä</div>
          <div style="font-size: 22px; font-weight: 900; color: #667eea;">${accuracy}%</div>
          <div style="opacity: 0.6; font-size: 12px;">Accuracy</div>
        </div>
      </div>

      <button class="btn btn-danger" style="width: 100%;" onclick="logout()">üö™ Logout</button>
    </div>
  `);
}

function uploadAvatar() {
  const file = document.getElementById('avatar-upload').files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (e) => {
    const base64 = e.target.result;
    
    const updates = {
      ...currentUser,
      avatar_url: base64
    };

    const result = await window.dataSdk.update(updates);
    if (result.isOk) {
      currentUser = updates;
      alert('‚úÖ Avatar updated!');
      renderProfile();
    }
  };
  
  reader.readAsDataURL(file);
}

function initAuth() {
  document.getElementById('go-reg-link').addEventListener('click', () => {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'block';
  });

  document.getElementById('go-login-link').addEventListener('click', () => {
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('login-form').style.display = 'block';
  });

  document.getElementById('login-btn').addEventListener('click', async () => {
    const user = document.getElementById('login-user').value.trim();
    const pass = document.getElementById('login-pass').value;
    const err = document.getElementById('login-error');

    if (!user || !pass) {
      err.textContent = '‚ùå Please enter username and password';
      err.style.display = 'block';
      return;
    }

    const found = allUsers.find(u => u.username === user && u.password === pass && u.type === 'user');
    if (!found) {
      err.textContent = '‚ùå Invalid username or password';
      err.style.display = 'block';
      return;
    }

    currentUser = found;
    localStorage.setItem('practice_eng_user', found.__backendId);
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('main-app').style.display = 'flex';
    updateUIFromUser();
    navigateTo('home');
  });

  document.getElementById('reg-btn').addEventListener('click', async () => {
    const name = document.getElementById('reg-name').value.trim();
    const user = document.getElementById('reg-user').value.trim();
    const pass = document.getElementById('reg-pass').value;
    const err = document.getElementById('reg-error');

    if (!name || !user || !pass) {
      err.textContent = '‚ùå Please fill all fields';
      err.style.display = 'block';
      return;
    }

    if (allUsers.find(u => u.username === user && u.type === 'user')) {
      err.textContent = '‚ùå Username already taken';
      err.style.display = 'block';
      return;
    }

    const newUser = {
      type: 'user',
      username: user,
      password: pass,
      display_name: name,
      avatar_url: '',
      avatar_color: ['#667eea', '#764ba2', '#ff6b6b'][Math.floor(Math.random() * 3)],
      total_xp: 0,
      daily_streak: 0,
      correct_answers: 0,
      wrong_answers: 0,
      games_played: 0,
      created_at: new Date().toISOString()
    };

    const result = await window.dataSdk.create(newUser);
    if (result.isOk) {
      alert('‚úÖ Account created! Please login.');
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('login-user').value = user;
    }
  });

  document.getElementById('login-pass').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('login-btn').click();
  });
}

function updateUIFromUser() {
  document.getElementById('xp-display').textContent = currentUser.total_xp || 0;
  document.getElementById('streak-display').textContent = currentUser.daily_streak || 0;
}

function logout() {
  currentUser = null;
  localStorage.removeItem('practice_eng_user');
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('login-form').style.display = 'block';
  document.getElementById('register-form').style.display = 'none';
}

function shuffle(array) {
  const arr = [...array];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

const dataHandler = {
  onDataChanged(data) {
    allUsers = data;
  }
};

async function init() {
  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig: {},
      onConfigChange: async () => {},
      mapToCapabilities: () => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
      mapToEditPanelValues: () => new Map()
    });
  }

  await window.dataSdk.init(dataHandler);
  initAuth();

  const saved = localStorage.getItem('practice_eng_user');
  if (saved) {
    const user = allUsers.find(u => u.__backendId === saved);
    if (user) {
      currentUser = user;
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'flex';
      updateUIFromUser();
      navigateTo('home');
      return;
    }
  }
}

init();
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d40c123c662731f',t:'MTc3MjEyMjY2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
